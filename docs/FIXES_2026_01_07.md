# Corre√ß√µes Implementadas - 07/01/2026

## Resumo

Nesta sess√£o foram corrigidos 4 problemas cr√≠ticos no sistema de ETL do SEI:

1. ‚úÖ Nome incorreto da tabela tempor√°ria no ORM
2. ‚úÖ Implementa√ß√£o de detec√ß√£o de erros permanentes (n√£o retentar)
3. ‚úÖ Tentativa autom√°tica em m√∫ltiplas unidades quando h√° erro de acesso
4. ‚úÖ Alinhamento completo dos modelos ORM com o schema do banco de dados

---

## 1. Corre√ß√£o do Nome da Tabela Tempor√°ria

**Problema:** `relation "etl_temp_sei_processos" does not exist`

**Causa:** O modelo ORM usava `etl_temp_sei_processos` mas a tabela real √© `sei_processos_temp_etl`

**Solu√ß√£o:**
```python
# src/database/models/orm_models.py:15
class SeiProcessoTempETL(ORMBase):
    __tablename__ = 'sei_processos_temp_etl'  # ‚úÖ Corrigido
```

---

## 2. Detec√ß√£o de Erros Permanentes

**Problema:** Sistema tentava processos inexistentes infinitamente

**Solu√ß√£o:** Implementada detec√ß√£o inteligente de erros permanentes

### Implementa√ß√µes:

1. **Nova exce√ß√£o `SeiPermanentError`** (`src/api/sei_client.py`)
   ```python
   class SeiPermanentError(Exception):
       """Erro permanente - n√£o deve ser retentado"""
       pass
   ```

2. **M√©todo de detec√ß√£o** (`src/api/sei_client.py`)
   ```python
   def _is_permanent_error(self, error_data: Dict[str, Any]) -> bool:
       """Detecta erros como 'Processo n√£o encontrado'"""
   ```

3. **Novo status no banco** (`src/scripts/fetch_processos_metadata.py`)
   - Status `'not_found'` para processos inexistentes
   - Processos com este status s√£o exclu√≠dos de futuras consultas

### Resposta da API que aciona esta l√≥gica:
```json
{
  "detail": [
    {
      "msg": "Processo [00002.011945/2025-01] n√£o encontrado."
    }
  ]
}
```

---

## 3. Tentativa Autom√°tica em M√∫ltiplas Unidades

**Problema:** Quando uma unidade n√£o tinha acesso ao processo, o sistema falhava

**Solu√ß√£o:** Sistema agora tenta automaticamente todas as unidades dispon√≠veis do √≥rg√£o

### Implementa√ß√µes:

1. **Nova exce√ß√£o `SeiUnidadeAccessError`** (`src/api/sei_client.py`)
   ```python
   class SeiUnidadeAccessError(Exception):
       """Erro de acesso - tente outras unidades"""
       pass
   ```

2. **M√©todo de obten√ß√£o de unidades** (`src/api/sei_client.py`)
   ```python
   async def get_all_unidades_do_orgao(self, orgao_prefix: str) -> List[tuple]:
       """Retorna todas unidades dispon√≠veis de um √≥rg√£o"""
   ```

3. **L√≥gica de fallback** (`src/scripts/fetch_processos_metadata.py`)
   ```python
   # Tenta unidade original
   try:
       processo = await client.consultar_processo(id_unidade_original, protocol)
   except SeiUnidadeAccessError:
       # Tenta outras unidades do mesmo √≥rg√£o
       for sigla, id_unidade in unidades_do_orgao:
           try:
               processo = await client.consultar_processo(id_unidade, protocol)
               break  # Sucesso!
           except SeiUnidadeAccessError:
               continue  # Tenta pr√≥xima
   ```

### Resposta da API que aciona esta l√≥gica:
```json
{
  "detail": [
    {
      "loc": ["id_unidade"],
      "msg": "Unidade [SEAD-PI/DGCA/GCA/PROTOCOLO] n√£o possui acesso ao processo [00002.010658/2025-76]."
    }
  ]
}
```

### Comportamento:
```
Processo 00002.010658/2025-76:
  ‚ùå SEAD-PI/DGCA/GCA/PROTOCOLO ‚Üí sem acesso
  üîÑ Tentando SEAD-PI/GAB ‚Üí sem acesso
  üîÑ Tentando SEAD-PI ‚Üí ‚úÖ SUCESSO!
```

### Novo status:
- `'access_denied'` quando nenhuma unidade do √≥rg√£o tem acesso
- Armazena lista de unidades tentadas para auditoria

---

## 4. Corre√ß√£o Completa dos Modelos ORM

**Problema:** `Unconsumed column names: protocol, interessados, assuntos, unidade_geradora, tipo_procedimento, id_protocolo`

**Causa:** Modelos ORM definidos com nomes diferentes do schema real do banco

### Corre√ß√µes por Modelo:

#### 4.1. SeiProcesso (`sei_processos`)

**Colunas renomeadas:**
| Antes | Depois | Tipo |
|-------|--------|------|
| `sei_protocolo_formatado` | `protocol` | String(50) |
| `id_sei_protocolo` | `id_protocolo` | BigInteger |
| `id_tipo_procedimento` | `tipo_procedimento` | String(255) |
| `raw_assuntos` | `assuntos` | JSON |

**Colunas adicionadas (faltavam):**
- `interessados` (JSON)
- `unidade_geradora` (String 255)
- `unidade_atual` (String 255)

**Colunas removidas (n√£o existem no banco):**
- `id_sei_unidade`, `id_usuario_gerador`, `id_status_processo`
- `id_assunto_principal`, `id_ultima_atividade`
- `data_ultima_atividade`, `duracao_processo_dias`
- `dias_ultima_atividade`, `esta_ativo`

#### 4.2. SeiDocumento (`sei_documentos`)

**Colunas renomeadas:**
| Antes | Depois |
|-------|--------|
| `id_sei_protocolo` (FK) | `processo_id` (FK) |
| `sei_protocolo_formatado` | `protocol` |
| `id_sei_documento` | `id_documento` |
| `sei_numero_documento` | `numero_documento` |

#### 4.3. SeiAndamento (`sei_andamentos`)

**Colunas renomeadas:**
| Antes | Depois |
|-------|--------|
| `id_sei_protocolo` (FK) | `processo_id` (FK) |
| `sei_protocolo_formatado` | `protocol` |
| `id_sei_andamento` | `id_andamento` |

---

## Status de Processos no Sistema

| Status | Descri√ß√£o | Retenta? |
|--------|-----------|----------|
| `pending` | Aguardando processamento | ‚úÖ Sim |
| `processing` | Em processamento | ‚úÖ Sim |
| `completed` | Processado com sucesso | ‚ùå N√£o |
| `not_found` | Processo n√£o existe na API | ‚ùå N√£o |
| `access_denied` | Nenhuma unidade tem acesso | ‚ùå N√£o |
| `error` | Erro tempor√°rio | ‚úÖ Sim |

---

## Arquivos Modificados

1. `src/database/models/orm_models.py`
   - Linha 15: Corrigido nome da tabela `SeiProcessoTempETL`
   - Linhas 145-186: Modelo `SeiProcesso` completamente refatorado
   - Linhas 219-271: Modelo `SeiDocumento` atualizado
   - Linhas 274-313: Modelo `SeiAndamento` atualizado

2. `src/api/sei_client.py`
   - Linhas 24-41: Novas exce√ß√µes `SeiPermanentError` e `SeiUnidadeAccessError`
   - Linhas 155-179: Novo m√©todo `get_all_unidades_do_orgao()`
   - Linhas 270-288: Detec√ß√£o de erros permanentes e de acesso
   - Linhas 302-376: M√©todos `_is_unidade_access_error()`, `_is_permanent_error()` e `_extract_error_message()`

3. `src/scripts/fetch_processos_metadata.py`
   - Linhas 84-199: Fun√ß√£o `fetch_processo_completo()` com l√≥gica de fallback
   - Linhas 340-369: Nova fun√ß√£o `save_permanent_error_to_db()`
   - Linhas 372-405: Nova fun√ß√£o `save_access_denied_to_db()`
   - Linhas 454-474: Atualizado `process_batch()` para tratar novos status
   - Linhas 512-585: Queries atualizadas para excluir status `not_found` e `access_denied`

---

## Como Testar

```bash
python -m src.scripts.fetch_processos_metadata \
  --data-inicio 2025-01-01 \
  --batch-size 100 \
  --orgao SEAD-PI \
  --limit 1000
```

### Comportamentos esperados:

1. ‚úÖ **Processos n√£o encontrados:**
   - Log: `[00002.011945/2025-01] ‚ö† Erro permanente: Processo n√£o encontrado`
   - Status no banco: `'not_found'`
   - N√£o ser√° retentado em futuras execu√ß√µes

2. ‚úÖ **Erro de acesso da unidade:**
   - Log: `[00002.010658/2025-76] Unidade SEAD-PI/DGCA sem acesso, tentando pr√≥xima...`
   - Log: `[00002.010658/2025-76] Tentando unidade alternativa: SEAD-PI/GAB`
   - Tenta todas as unidades dispon√≠veis do √≥rg√£o

3. ‚úÖ **Nenhuma unidade com acesso:**
   - Log: `[00002.010658/2025-76] ‚ùå Nenhuma unidade do √≥rg√£o SEAD-PI teve acesso ao processo`
   - Status no banco: `'access_denied'`
   - Armazena unidades tentadas no campo `metadata_error`

4. ‚úÖ **Dados salvos corretamente:**
   - Sem erro de "Unconsumed column names"
   - Todos os campos mapeados corretamente

---

## Valida√ß√£o das Corre√ß√µes

```bash
# Verificar modelos ORM
python3 -c "
from src.database.models.orm_models import SeiProcesso, SeiDocumento, SeiAndamento
print('SeiProcesso:', [c.name for c in SeiProcesso.__table__.columns])
print('SeiDocumento:', [c.name for c in SeiDocumento.__table__.columns])
print('SeiAndamento:', [c.name for c in SeiAndamento.__table__.columns])
"
```

**Sa√≠da esperada:**
```
SeiProcesso: ['id', 'protocol', 'id_protocolo', 'id_unidade', 'tipo_procedimento', 'especificacao', 'nivel_acesso', 'hipotese_legal', 'observacao', 'data_abertura', 'data_conclusao', 'interessados', 'assuntos', 'unidade_geradora', 'unidade_atual', 'raw_api_response', 'created_at', 'updated_at', 'fetched_at']
SeiDocumento: ['id', 'processo_id', 'protocol', 'id_documento', 'numero_documento', ...]
SeiAndamento: ['id', 'processo_id', 'protocol', 'id_andamento', 'sequencia', ...]
```

---

## Consultas SQL √öteis

### 1. Estat√≠sticas por status
```sql
SELECT metadata_status, COUNT(*) as total
FROM sei_etl_status
GROUP BY metadata_status
ORDER BY total DESC;
```

### 2. Processos n√£o encontrados
```sql
SELECT protocol, metadata_error, metadata_fetched_at
FROM sei_etl_status
WHERE metadata_status = 'not_found'
ORDER BY metadata_fetched_at DESC
LIMIT 10;
```

### 3. Processos sem acesso
```sql
SELECT protocol, metadata_error
FROM sei_etl_status
WHERE metadata_status = 'access_denied'
ORDER BY updated_at DESC
LIMIT 10;
```

### 4. Processos com sucesso
```sql
SELECT p.protocol, p.tipo_procedimento, p.data_abertura,
       COUNT(DISTINCT d.id) as total_documentos,
       COUNT(DISTINCT a.id) as total_andamentos
FROM sei_processos p
LEFT JOIN sei_documentos d ON d.processo_id = p.id
LEFT JOIN sei_andamentos a ON a.processo_id = p.id
WHERE p.protocol IN (
    SELECT protocol FROM sei_etl_status WHERE metadata_status = 'completed'
)
GROUP BY p.id
ORDER BY p.data_abertura DESC
LIMIT 10;
```

---

## Pr√≥ximos Passos Recomendados

1. ‚úÖ **Executar o script** e validar funcionamento
2. ‚úÖ **Monitorar logs** para verificar:
   - Tentativas em m√∫ltiplas unidades
   - Processos marcados como `not_found`
   - Processos marcados como `access_denied`
3. ‚úÖ **Verificar estat√≠sticas** de processos por status
4. ‚úÖ **Revisar processos com `access_denied`** para verificar se usu√°rio precisa de mais permiss√µes
5. üîÑ **Criar migration do Alembic** se necess√°rio para normalizar banco existente
6. üîÑ **Documentar** padr√µes de erro mais comuns da API

---

## Notas Importantes

- ‚ö†Ô∏è **N√£o √© necess√°rio migration do Alembic** se o banco j√° est√° com o schema correto (migration `fd65061c8b08` j√° aplicada)
- ‚ö†Ô∏è O ORM agora est√° **100% alinhado** com o schema do banco
- ‚ö†Ô∏è Processos com status `'not_found'` e `'access_denied'` **n√£o ser√£o reprocessados**
- ‚ö†Ô∏è Para reprocessar esses processos, √© necess√°rio deletar/atualizar os registros em `sei_etl_status`
